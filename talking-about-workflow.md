# GitHub Workflow Example

[Here's the current workflow file I have](https://github.com/jpratt-mru/starting-autograded-template/blob/master/.github/workflows/submit.yml); let's talk about it.
(You might want to have it to follow along.)

## line-by-line notes

I won't go over **every** line (you can dig https://docs.github.com/en/actions/getting-started-with-github-actions to learn more about workflows and actions...it's pretty good, as documentation goes).

### `name`

- feel free to give it a more appropriate name
- shows up here:

  ![Alt text](images/name-capture.png)

### `on > workflow_dispatch:`

- use this if you want users to trigger an action manually instead of automatically. [further details here](https://docs.github.com/en/actions/configuring-and-managing-workflows/configuring-a-workflow#manually-running-a-workflow)
- at first, I had `on: push`...I thought this made the most sense - every time someone pushed to the repo, you'd want to run the actions, right? Wrong. For one, when GitHub Classroom does its thing, there are **three** pushes done by the creator of the template repo! So each of those pushes triggers the workflow! So not only is the poor student spammed with three extra notifications out of the gate...but that's three times as many minutes counted to the organization's Action minutes quota! AND if you have a student with a (typically admirable) "commit and push often" habit, that's even **more** quota being burned.
- the `inputs` section creates a [github context](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) called `github.event.inputs.MRU_username` that we can use later when we name the results/report artifact
  - note that though you can technically supply a default here, we don't want to: students need to enter _something_ here - hopefully a valid username! :)

### `continue-on-error: true`

- without this, the workflow will use the default value of false and the minute something goes wrong (like compilation fails or a PMD violation is found, etc), the workflow stops - but we don't want this, since we want to generate a summary report about all the problems!

### `Checkout...`

- very common GitHub action that pulls the current repo down onto the virtual machine - you need this!!!

### `Set up env vars`

- we want to grab the repo name in order to use it as part of the artifact zip file name...but unfortunately, Actions only has a way to grab OWNER/REPO-NAME and that damn slash can't be part of the name!
  - we use Bash substitution and remove everything up to and including the first slash in the Action environment variable called GITHUB_REPOSITORY
  - the `echo "::set-env"` part is how you create new environment variables
    > - [ref](https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions#setting-an-environment-variable)
    > - [useful example](https://github.community/t/syntax-for-replacing-characters-in-string/17240/2)
    - **gotcha**: the environment variable is available from the _following task onward_

### `Show env vars`

- probably should get rid of this...it was just for debugging, but it's instructional and runs quickly, so I'm punting on it

### `Set up Java....`

- you can choose different Java versions to put on the virtual machine...very convenient!
  > [ref](https://github.com/actions/setup-java)

### `Get standard test files and such`

> **pro tip**: when you do a `run` in an action, you can chain a whole bunch of things together if you start out with a pipe `|` on its own on one line followed by all the individual commands following one per line

- this whole block's job in life is to make sure that
  - any external libs needed for compilation,
  - Checkstyle and PMD configuration files, and
  - unit tests
    are copied into the workflow's virtual machine so that these important files are guaranteed to be in the project directory when the rest of the actions do their thing
- this is partially done out of paranoia - if a student wanted to, they could play with the configs and tests to change the result of the upcoming checks!
- this step also lets instructors bring in **further tests** - so they can give _some_ tests in the project template and then test with _additional_ ones as well
  > this is a bit of labour that needs to go into making this work, because you have to make a zip file of the necessary folders, place this zip file in its own **public** repo (otherwise the wget will fail...or at least require some extra work to handle authentication to get into a private repo!), and make sure that if any changes are made to lib/config/test, that everything gets updated!
- this step also creates the `results` directory (which holds the raw results from compilation, checkstyle validation, pmd validation, and unit test reports) and the `reports` directory, which holds the summary report generated by the [cisummarizer tool](https://github.com/jpratt-mru/cisummarizer).

### `Compile that source code....`

- since we're only interested in errors, we have the funky `2>` to redirect stderr to a file (if there are no errors, it'll be empty, but that's cool)
  > **important**: if you change the location of source directories or have students work with packages, remember that the compile command will need to be tweaked

### `Generate PMD report`

- we use the `if: ${{ always() }}` to make sure that this is run even if compilation doesn't happen (a student could have well-written non-compiling code simply because they're working on fixing something on working code that causes it to temporarily bust)
- we do another PMD action to save the PMD report in a more human-readable version...might come in handy later!

### `Generate Checkstyle report`

- pretty well identical to the PMD entry

### `Generate test report`

- pretty well identical to the PMD entry

### `Alter default junit reports`

- the junit test results need to be renamed first (as they can't be renamed by the junit runner itself); we also delete the unneeded vintage junit report

### `Generate summary report`

- uses the [cisummarizer tool](https://github.com/jpratt-mru/cisummarizer) to create a summary report in the reports directory

### `Save the results as artifact`

- uses the [upload-artifact action](https://github.com/marketplace/actions/upload-a-build-artifact) to save the `results` and `reports` directories to a single zipfile named `[mru username]-[name of repo].zip`

### `Create an issue from the result`

- uses the [create-issue-from-file](https://github.com/marketplace/actions/create-issue-from-file) action to take the text in the summary report and use it as a body in an issue that is created
